"use strict"
var mongoose = require('mongoose'),
    code = require('../../../Data/Code.js'),
    msg = require('../../../Data/Message.js'),
    utils = require('../../../Utils/MainUtils.js'),
    UserPointController = require('../../User/Points/PointController.js'),
    Event = mongoose.model('TrafficEvent'),
    User = mongoose.model('User'),
    EventPoint = mongoose.model('TrafficEventPoint'),
    UserPoint = mongoose.model('PointByMonth')
;
const
    codeServerError = 500,
    codeBadRequest = 400,
    codeNotFound = 401,

    msgServerError = "Server Internal Error",
    userNotFound = "User doesn't exist",
    userIdNotFound = "Please enter your user Id",
    latitudeNotFound = "Please enter latitude of the event",
    longitudeNotFound = "Please enter longitude of the event",
    endLatitudeNotFound = "Please enter the end_latitude of the event",
    endLongitudeNotFound = "Please enter the end_longitude of the event",
    eventNotFound = "Event not found",
    noUpdateUserId = "Can't update user Id",
    invalidEventType = "eventType is invalid",
    invalidDensity = "density is invalid",
    invalidCarSpeed = "car_speed is invalid",
    invalidMotorbikeSpeed = "motorbike_speed is invalid"
    ;
const
    codeSuccess = 200,
    msgSuccess = "Success"
;

exports.createEvent = function (req,res) {
    var body = req.body;
    if(!body.userId){
        return utils.result(res,codeBadRequest,userIdNotFound,null);
    }
    if(!body.latitude){
        return utils.result(res,codeBadRequest,latitudeNotFound,null);
    }
    if(!body.longitude){
        return utils.result(res,codeBadRequest,longitudeNotFound,null);
    }
    if(!body.end_latitude){
        return utils.result(res,codeBadRequest,endLatitudeNotFound,null);
    }
    if(!body.end_longitude){
        return utils.result(res,codeBadRequest,endLongitudeNotFound,null);
    }
    if(body.eventType && (body.eventType > 4 || body.eventType < 0)){
        return utils.result(res,codeBadRequest,invalidEventType,null);
    }
    if(body.density && (body.density < 0 || body.density >4)){
        return utils.result(res,codeBadRequest,invalidDensity,null);
    }
    if(body.motorbike_speed && (body.motorbike_speed <0 || body.motorbike_speed > 3)){
        return utils.result(res,codeBadRequest,invalidMotorbikeSpeed,null);
    }
    if(body.car_speed && (body.car_speed <0 || body.car_speed > 3)){
        return utils.result(res,codeBadRequest,invalidCarSpeed,null);
    }
    var newEvent = Event(body);
    User.findOne({
        _id:body.userId
    },function (err,userExist) {
        if(!userExist){
            return utils.result(res,codeNotFound,userNotFound,null);
        }
        if(err){
            console.log(err);
            return utils.result(res, codeServerError, msgServerError, null);
        }
        newEvent.save(function (err,event) {
            if(err){
                console.log(err);
                return utils.result(res, codeServerError, msgServerError, null);
            }
            else {
                var eventPoint = new EventPoint({
                    event_id:event._id
                });
                eventPoint.save(function (err,point) {
                    if(err){
                        console.log(err);
                        return utils.result(res,codeServerError,msgServerError,null);
                    }
                    var body=({
                       Event:event,
                       EventPoint:point
                    });
                    return utils.result(res, codeSuccess, msgSuccess,body);
                });
            }
        });
    });

};

exports.getAllEvents = function (req,res) {
    Event.find({}, function (err,allEvents) {
        if(err){
            return utils.result(res, codeServerError, msgServerError,null);
        }
        return utils.result(res,codeSuccess,msgSuccess,allEvents)
    })
};

exports.getEventById = function (req,res) {
    Event.findOne({
       _id:req.params.eventId
    }, function (err,eventExist) {
        if(!eventExist){
            return utils.result(res,codeNotFound,eventNotFound,null);
        }
        if(err){
            console.log(err);
            return utils.result(res, codeServerError, msgServerError, null);
        }
        return utils.result(res,codeSuccess,msgSuccess,eventExist);
    });
};

exports.updateEventById = function (req,res) {
    var body = req.body;
    if(req.body._id){
        return utils.result(res,codeBadRequest,noUpdateUserId,null);
    }
    if(body.eventType && (body.eventType > 4 || body.eventType < 0)){
        return utils.result(res,codeBadRequest,invalidEventType,null);
    }
    if(body.density && (body.density < 0 || body.density >4)){
        return utils.result(res,codeBadRequest,invalidDensity,null);
    }
    if(body.motorbike_speed && (body.motorbike_speed <0 || body.motorbike_speed > 3)){
        return utils.result(res,codeBadRequest,invalidMotorbikeSpeed,null);
    }
    if(body.car_speed && (body.car_speed <0 || body.car_speed > 3)){
        return utils.result(res,codeBadRequest,invalidCarSpeed,null);
    }

    Event.findByIdAndUpdate(req.params.eventId, body,{new: true}, function (err, event) {
        if(!event)
            return utils.result(res, codeNotFound, eventNotFound, null);
        if(err)
            return utils.result(res, codeServerError, msgServerError, null);
        return utils.result(res, codeSuccess, msgSuccess, event);
    });
};

exports.deleteEvent = function (req,res) {
    Event.findOne({
        _id:req.params.eventId
    }, function (err,eventExist) {
        if(err) {
            return utils.result(res, codeServerError, msgServerError, null);
        }
        if(eventExist) {
            Event.remove({
                _id:req.params.eventId
            }, function (err, deleted) {
                if(!deleted){
                    return utils.result(res, codeNotFound, eventNotFound, null);
                }
                if(err) {
                    return utils.result(res, codeServerError, msgServerError, null);
                }
                if(deleted){
                    return utils.result(res, codeSuccess, msgSuccess, null);
                }
            });
        }
        else{
            return utils.result(res, codeNotFound, eventNotFound, null);
        }
    });
};
exports.upvote = function(req,res){
    EventPoint.findOneAndUpdate(
        {event_id:req.params.eventId},
        {$inc:{upvotes:1}},
        {new: true},
        function (err,result) {
            if(err) {
                console.log(err);
                return utils.result(res, code.serverError, msg.serverError, null);
            }
            if(!result)
                return utils.result(res,code.notFound,msg.eventNotFound,null);

            if(updateUserPoint(true,result.event_id) == false)
                return utils.result(res,code.serverError,msg.serverError,null);
            return utils.result(res,code.success,msg.success,result);
        }
    );
};
exports.downvote = function(req,res){
    EventPoint.findOneAndUpdate(
        {event_id:req.params.eventId},
        {$inc:{downvotes:1}},
        {new: true},
        function (err,result) {
            if(err) {
                console.log(err);
                return utils.result(res, code.serverError, msg.serverError, null);
            }
            if(!result)
                return utils.result(res,code.notFound,msg.eventNotFound,null);

            if(updateUserPoint(false,result.event_id) == false)
                return utils.result(res,code.serverError,msg.serverError,null);
            return utils.result(res,code.success,msg.success,result);
        }
    );
};
function updateUserPoint(isUpvote,eventId){
    Event.findOne(
        {_id:eventId},
        function (err,event) {
            if(err) {
                console.log(err)
                return false;
            }
            return UserPointController.updatePoint(event.userId,isUpvote)
        }
    );
}